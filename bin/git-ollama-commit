#!/usr/bin/env node

const { execSync } = require('child_process');
const http = require('http');

// Constants
const MAX_DIFF_LENGTH = 5000; // Limit diff size to prevent timeout issues
const TIMEOUT_MS = 30000; // 30 second timeout

// Check if Ollama is running
function isOllamaRunning() {
  try {
    execSync('curl -s http://localhost:11434/api/tags', { stdio: 'pipe' });
    return true;
  } catch (error) {
    return false;
  }
}

// Get git diff
function getGitDiff() {
  try {
    return execSync('git diff --cached', { encoding: 'utf8' });
  } catch (error) {
    console.error('Error getting git diff:', error.message);
    process.exit(1);
  }
}

// Truncate diff if too large
function truncateDiff(diff) {
  if (diff.length <= MAX_DIFF_LENGTH) {
    return diff;
  }
  
  console.log(`Diff too large (${diff.length} chars), truncating to ${MAX_DIFF_LENGTH} chars...`);
  return diff.substring(0, MAX_DIFF_LENGTH) + '\n\n[Diff truncated due to size]\n';
}

// Generate commit message with Ollama
async function generateCommitMessage(diff) {
  const truncatedDiff = truncateDiff(diff);
  const prompt = `You are an expert at following conventional commit guidelines. Based on the following git diff, generate a concise, informative commit message that follows conventional commit format (type: subject). Focus on the key changes and their purpose. Keep it under 72 characters.\n\n${truncatedDiff}`;
  
  const data = JSON.stringify({
    model: "qwen3-coder:480b-cloud",
    prompt: prompt,
    stream: false
  });

  const options = {
    hostname: 'localhost',
    port: 11434,
    path: '/api/generate',
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Content-Length': Buffer.byteLength(data)
    },
    timeout: TIMEOUT_MS
  };

  return new Promise((resolve, reject) => {
    const req = http.request(options, (res) => {
      let responseBody = '';

      res.on('data', (chunk) => {
        responseBody += chunk;
      });

      res.on('end', () => {
        try {
          const response = JSON.parse(responseBody);
          // Check if there's an error in the response
          if (response.error) {
            reject(new Error(response.error));
            return;
          }
          if (!response.response) {
            reject(new Error('No response from Ollama'));
            return;
          }
          resolve(response.response.trim());
        } catch (error) {
          reject(new Error(`Failed to parse Ollama response: ${error.message}\nResponse: ${responseBody}`));
        }
      });
    });

    req.on('error', (error) => {
      reject(new Error(`HTTP request failed: ${error.message}`));
    });

    req.on('timeout', () => {
      req.destroy();
      reject(new Error('Request to Ollama timed out'));
    });

    req.write(data);
    req.end();
  });
}

// Parse command line arguments
function parseArgs() {
  const args = process.argv.slice(2);
  return {
    dryRun: args.includes('--dry-run') || args.includes('-d')
  };
}

// Main function
async function main() {
  const { dryRun } = parseArgs();
  
  // Check if there are staged changes
  try {
    execSync('git diff --cached --quiet', { stdio: 'pipe' });
    console.error('No staged changes. Please stage your changes with git add first.');
    process.exit(1);
  } catch (error) {
    // This means there ARE staged changes, which is what we want
  }

  if (!isOllamaRunning()) {
    console.error('Ollama is not running. Please start Ollama first with: ollama serve');
    process.exit(1);
  }

  const diff = getGitDiff();
  
  if (!diff.trim()) {
    console.error('No changes to commit.');
    process.exit(1);
  }

  console.log('Generating commit message with Ollama...');
  console.log(`Diff size: ${diff.length} characters`);
  
  try {
    const commitMessage = await generateCommitMessage(diff);
    console.log(`Generated commit message: ${commitMessage}`);
    
    if (dryRun) {
      console.log('Dry run: commit not executed.');
      return;
    }
    
    // Commit with the generated message
    execSync(`git commit -m "${commitMessage}"`, { stdio: 'inherit' });
    console.log('Changes committed successfully!');
  } catch (error) {
    console.error('Error generating commit message:', error.message);
    process.exit(1);
  }
}

main();// Test change for --dry-run feature
